extends ../common/layout

block layout-content
  .row.justify-content-center
    .col-lg-10
      .card.shadow-sm
        .card-body.p-4
          h1.h3.mb-4.text-center Add New Article

          //- Added an ID to the form so we can easily target it in JS
          form#add-article-form(action="/admin/article/add/submit", method="post", enctype="multipart/form-data", autocomplete="off")
            // Title
            .mb-3
              label.form-label(for="title") Title
              input.form-control(
                type="text",
                id="title",
                name="title",
                placeholder="Add hook title",
                autocomplete="off",
                required
              )

            // Article Text
            .mb-3
              label.form-label(for="article-text") Article Text
              textarea.form-control(
                id="article-text",
                name="text",
                rows="10",
                placeholder="Write your full article here...",
                style="min-height: 200px",
                autocomplete="off"
              )

            // Category
            .mb-3
              label.form-label(for="cat") Select Category
              select.form-select(id="cat", name="categoryId", required)
                option(value="") Select a category
                each cat in categories
                  option(value=cat._id)= cat.name

            // IMAGE & CAPTION UPLOAD SECTION
            .mb-4
              label.form-label.fw-bold Article Images
              #image-container
                // The first image block (Required for the Hero image)
                .image-block.border.rounded.p-3.mb-3.bg-light
                  .row
                    .col-md-6.mb-2.mb-md-0
                      label.form-label.small Upload Image
                      input.form-control(
                        type="file",
                        name="images",
                        accept="image/*",
                        required
                      )
                    .col-md-6
                      label.form-label.small Image Caption (Source / Alt text)
                      input.form-control(
                        type="text",
                        name="alt",
                        placeholder="e.g., Photo by Reuters / TSMC Factory"
                      )
              
              // Button to dynamically add more image/caption blocks
              button#add-more-images.btn.btn-outline-secondary.btn-sm(type="button")
                | + Add Another Image

            // Buttons
            .d-flex.justify-content-end.gap-2.mt-4
              a.btn.btn-secondary(href="/admin/article") Cancel
              
              //- ðŸŒŸ NEW: Submit button with hidden spinner
              button#submit-btn.btn.btn-primary(type="submit")
                span#submit-spinner.spinner-border.spinner-border-sm.d-none.me-2(role="status", aria-hidden="true")
                span#submit-text Add Article

  // ðŸŒŸ SCRIPT TO HANDLE ADDING MORE IMAGES AND LOADING STATE
  script.
    document.addEventListener('DOMContentLoaded', function() {
      // --- 1. HANDLE ADDING MORE IMAGES ---
      const addBtn = document.getElementById('add-more-images');
      const container = document.getElementById('image-container');

      addBtn.addEventListener('click', function() {
        const originalBlock = container.querySelector('.image-block');
        const newBlock = originalBlock.cloneNode(true);

        newBlock.querySelector('input[type="file"]').value = '';
        newBlock.querySelector('input[type="text"]').value = '';
        newBlock.querySelector('input[type="file"]').removeAttribute('required');

        container.appendChild(newBlock);
      });

      // --- 2. ðŸŒŸ HANDLE FORM SUBMISSION & LOADING STATE ---
      const form = document.getElementById('add-article-form');
      const submitBtn = document.getElementById('submit-btn');
      const submitSpinner = document.getElementById('submit-spinner');
      const submitText = document.getElementById('submit-text');

      form.addEventListener('submit', function(e) {
        // We do NOT use e.preventDefault() here because we want the form to actually submit to the backend.
        // We only want to change the UI while the browser waits for the server response.

        // Disable the button to prevent double-clicks
        submitBtn.disabled = true;
        
        // Show the spinner and change the text
        submitSpinner.classList.remove('d-none');
        submitText.textContent = 'Optimizing & Uploading...';
      });
    });