extends ../common/layout

block layout-content
    .row.justify-content-center
        .col-lg-10
            .card.shadow-sm
                .card-body.p-4
                    h1.h3.mb-4.text-center Edit Article

                    // Form sends updated data to /admin/article/edit/submit
                    form(action="/admin/article/edit/submit", method="post", enctype="multipart/form-data")
                        // Hidden field: article ID
                        input(type="hidden", name="articleId", value=editArticle._id)

                        // Title field
                        .mb-3
                            label.form-label(for="title") Title
                            input.form-control(
                                type="text",
                                id="title",
                                name="title",
                                value=editArticle.title,
                                required
                            )

                        //- Article text field
                        .mb-3
                            label.form-label(for="article-text") Article Text
                            textarea.form-control(
                                id="article-text",
                                name="text",
                                rows="10",
                                required
                            ) #{editArticle.text}

                        // Category dropdown (preloaded)
                        .mb-3
                            label.form-label(for="cat") Select Category
                            select.form-select(id="cat", name="categoryId", required)
                                option(value="") Choose a category
                                each cat in categories
                                    option(
                                        value=cat._id,
                                        selected=cat._id.toString() === editArticle.categoryId._id.toString()
                                    )= cat.name

                        //- ðŸŒŸ UPDATED: Display existing images WITH EDITABLE CAPTIONS
                        if editArticle.images && editArticle.images.length > 0
                            .mb-4
                                label.form-label.fw-bold Existing Images
                                .row.g-3#existingImages
                                    each image, index in editArticle.images
                                        .col-md-4.image-card(data-image-index=index, data-image-key=image.key, data-article-id=editArticle._id)
                                            .card.position-relative.h-100
                                                img.card-img-top(src=image.url, alt=image.alt || editArticle.title, style="height: 150px; object-fit: cover;")
                                                .card-body.p-3.d-flex.flex-column
                                                    label.form-label.small.text-muted Edit Caption:
                                                    
                                                    // Hidden input so backend knows WHICH image this is
                                                    input(type="hidden", name="existingImageKeys", value=image.key)
                                                    
                                                    // Editable input for the caption
                                                    input.form-control.form-control-sm.mb-3(
                                                        type="text",
                                                        name="existingImageAlts",
                                                        value=image.alt,
                                                        placeholder="Enter caption..."
                                                    )
                                                    
                                                    button.btn.btn-danger.btn-sm.w-100.mt-auto.delete-image-btn(type="button")
                                                        i.bi.bi-trash.me-1
                                                        | Delete

                        //- Add new images section
                        .mb-4
                            .card.bg-light
                                .card-body
                                    label.form-label.fw-bold
                                        i.bi.bi-cloud-upload.me-2
                                        | Add New Images (optional)
                                    
                                    #image-container
                                        // The first block (NOT required for edit)
                                        .image-block.border.rounded.p-3.mb-3.bg-white
                                            .row
                                                .col-md-6.mb-2.mb-md-0
                                                    label.form-label.small Upload Image
                                                    input.form-control(
                                                        type="file",
                                                        name="images",
                                                        accept="image/*"
                                                    )
                                                .col-md-6
                                                    label.form-label.small Image Caption (Source / Alt text)
                                                    input.form-control(
                                                        type="text",
                                                        name="alt",
                                                        placeholder="e.g., Photo by Reuters / TSMC Factory"
                                                    )
                                    
                                    // Button to dynamically add more image/caption blocks
                                    button#add-more-images.btn.btn-outline-secondary.btn-sm(type="button")
                                        | + Add Another Image

                        // Buttons
                        .d-flex.justify-content-end.gap-2.mt-4
                            a.btn.btn-secondary(href="/admin/article") Cancel
                            button.btn.btn-primary(type="submit") Save Changes

    //- Image clone and delete script
    script.
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Logic for adding more image blocks
            const addBtn = document.getElementById('add-more-images');
            const container = document.getElementById('image-container');

            if (addBtn && container) {
                addBtn.addEventListener('click', function() {
                    const originalBlock = container.querySelector('.image-block');
                    const newBlock = originalBlock.cloneNode(true);

                    // Clear the values
                    newBlock.querySelector('input[type="file"]').value = '';
                    newBlock.querySelector('input[type="text"]').value = '';

                    container.appendChild(newBlock);
                });
            }
            
            // 2. Logic for deleting existing images
            const deleteButtons = document.querySelectorAll('.delete-image-btn');
            
            deleteButtons.forEach(button => {
                button.addEventListener('click', async function(e) {
                    const imageCard = this.closest('.image-card');
                    const articleId = imageCard.getAttribute('data-article-id');
                    const imageKey = imageCard.getAttribute('data-image-key');
                    
                    if (!confirm('Are you sure you want to delete this image?')) {
                        return;
                    }
                    
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
                    
                    try {
                        const response = await fetch('/admin/article/delete-image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                articleId: articleId,
                                imageKey: imageKey
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            imageCard.remove();
                        } else {
                            alert('Error: ' + (result.error || 'Failed to delete image'));
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-trash me-1"></i>Delete';
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('Error: ' + error.message);
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-trash me-1"></i>Delete';
                    }
                });
            });
        });