extends ../common/layout

block layout-content
    .row.justify-content-center
        .col-lg-10
            .card.shadow-sm
                .card-body.p-4
                    h1.h3.mb-4.text-center Edit Article

                    // Form sends updated data to /admin/article/edit/submit
                    form(action="/admin/article/edit/submit", method="post", enctype="multipart/form-data")
                        // Hidden field: article ID
                        input(type="hidden", name="articleId", value=editArticle._id)

                        // Title field
                        .mb-3
                            label.form-label(for="title") Title
                            input.form-control(
                                type="text",
                                id="title",
                                name="title",
                                value=editArticle.title,
                                required
                            )

                        //- Article text field
                        .mb-3
                            label.form-label(for="article-text") Article Text
                            textarea.form-control(
                                id="article-text",
                                name="text",
                                rows="10",
                                required
                            ) #{editArticle.text}

                        // Category dropdown (preloaded)
                        .mb-3
                            label.form-label(for="cat") Select Category
                            select.form-select(id="cat", name="categoryId", required)
                                option(value="") Choose a category
                                each cat in categories
                                    option(
                                        value=cat._id,
                                        selected=cat._id.toString() === editArticle.categoryId._id.toString()
                                    )= cat.name

                        //- Display existing images
                        if editArticle.images && editArticle.images.length > 0
                            .mb-3
                                label.form-label Existing Images
                                .row.g-3#existingImages
                                    each image, index in editArticle.images
                                        .col-md-4.image-card(data-image-index=index, data-image-key=image.key, data-article-id=editArticle._id)
                                            .card.position-relative
                                                img.card-img-top(src=image.url, alt=image.alt || editArticle.title, style="height: 150px; object-fit: cover;")
                                                .card-body.p-2
                                                    if image.alt
                                                        small.text-muted.d-block.mb-1= image.alt
                                                    small.text-muted.d-block.mb-2 Key: #{image.key}
                                                    button.btn.btn-danger.btn-sm.w-100.delete-image-btn(type="button")
                                                        i.bi.bi-trash.me-1
                                                        | Delete

                        //- Add new images section
                        .mb-4
                            .card.bg-light
                                .card-body
                                    label.form-label.fw-bold(for="images")
                                        i.bi.bi-cloud-upload.me-2
                                        | Add New Images (optional)
                                    input.form-control.form-control-lg(
                                        type="file",
                                        id="images",
                                        name="images",
                                        multiple,
                                        accept="image/*"
                                    )
                                    small.form-text.text-muted
                                        i.bi.bi-info-circle.me-1
                                        | New images will be added to existing ones. You can select multiple files.
                                    
                                    //- Preview area for new images
                                    #imagePreview.mt-3.d-none
                                        .small.text-muted.mb-2 Preview:
                                        .row.g-2#previewContainer

                        // Buttons
                        .d-flex.justify-content-end.gap-2.mt-4
                            a.btn.btn-secondary(href="/admin/article") Cancel
                            button.btn.btn-primary(type="submit") Save Changes

    //- Image preview and delete script
    script.
        console.log('Article edit page loaded');
        
        // Preview selected images
        const imageInput = document.getElementById('images');
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                const previewArea = document.getElementById('imagePreview');
                const previewContainer = document.getElementById('previewContainer');
                const files = e.target.files;
                
                if (files.length > 0) {
                    previewArea.classList.remove('d-none');
                    previewContainer.innerHTML = '';
                    
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const col = document.createElement('div');
                            col.className = 'col-md-3';
                            col.innerHTML = `
                                <div class="card">
                                    <img src="${event.target.result}" class="card-img-top" style="height: 100px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <small class="text-muted">${file.name}</small>
                                    </div>
                                </div>
                            `;
                            previewContainer.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    previewArea.classList.add('d-none');
                }
            });
        }
        
        // Delete image buttons
        const deleteButtons = document.querySelectorAll('.delete-image-btn');
        console.log('Found delete buttons:', deleteButtons.length);
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', async function(e) {
                console.log('Delete button clicked!');
                
                const imageCard = this.closest('.image-card');
                const articleId = imageCard.getAttribute('data-article-id');
                const imageKey = imageCard.getAttribute('data-image-key');
                
                console.log('Article ID:', articleId);
                console.log('Image Key:', imageKey);
                
                if (!confirm('Are you sure you want to delete this image?')) {
                    console.log('User cancelled');
                    return;
                }
                
                console.log('User confirmed, sending delete request...');
                
                // Disable button
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
                
                try {
                    const response = await fetch('/admin/article/delete-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            articleId: articleId,
                            imageKey: imageKey
                        })
                    });
                    
                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('Response data:', result);
                    
                    if (response.ok) {
                        imageCard.remove();
                        alert('Image deleted successfully!');
                    } else {
                        alert('Error: ' + (result.error || 'Failed to delete image'));
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-trash me-1"></i>Delete';
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error: ' + error.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-trash me-1"></i>Delete';
                }
            });
        });
